
<!-- Mock Test Content -->
<div class="mock-test">
    <div class="alert alert-info">
        <i class="fas fa-star me-2"></i>
        <strong>Complete OET Mock Test</strong> - This comprehensive test covers all four OET sections: Listening, Reading, Writing, and Speaking.
    </div>

    <!-- Section Navigation -->
    <div class="section-navigation mb-4">
        <div class="row">
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-primary w-100 section-btn active" onclick="showSection('listening')">
                    <i class="fas fa-headphones me-2"></i>Listening
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-primary w-100 section-btn" onclick="showSection('reading')">
                    <i class="fas fa-book me-2"></i>Reading
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-primary w-100 section-btn" onclick="showSection('writing')">
                    <i class="fas fa-pen me-2"></i>Writing
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-primary w-100 section-btn" onclick="showSection('speaking')">
                    <i class="fas fa-microphone me-2"></i>Speaking
                </button>
            </div>
        </div>
    </div>

    <!-- Listening Section -->
    <div id="listening-section" class="test-section">
        <h3><i class="fas fa-headphones me-2 text-primary"></i>Listening Section (45 minutes)</h3>
        
        <div class="alert alert-warning">
            <i class="fas fa-volume-up me-2"></i>
            <strong>Instructions:</strong> You will hear various healthcare conversations and presentations. Answer all questions based on what you hear.
        </div>

        <div class="mb-4">
            <h5>Part A: Consultation Extract</h5>
            <div class="card">
                <div class="card-body">
                    <div class="audio-player mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Audio Transcript:</strong> Doctor consulting with patient about back pain symptoms, discussing treatment options and follow-up care.
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 1: What is the patient's main complaint?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_1" value="0" id="q1_0">
                            <label class="form-check-label" for="q1_0">Back pain</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_1" value="1" id="q1_1">
                            <label class="form-check-label" for="q1_1">Chest pain</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_1" value="2" id="q1_2">
                            <label class="form-check-label" for="q1_2">Headache</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_1" value="3" id="q1_3">
                            <label class="form-check-label" for="q1_3">Stomach ache</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 2: How long has the patient had symptoms?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_2" value="0" id="q2_0">
                            <label class="form-check-label" for="q2_0">2 days</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_2" value="1" id="q2_1">
                            <label class="form-check-label" for="q2_1">1 week</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_2" value="2" id="q2_2">
                            <label class="form-check-label" for="q2_2">3 weeks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_2" value="3" id="q2_3">
                            <label class="form-check-label" for="q2_3">2 months</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 3: What medication is prescribed?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_3" value="0" id="q3_0">
                            <label class="form-check-label" for="q3_0">Paracetamol</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_3" value="1" id="q3_1">
                            <label class="form-check-label" for="q3_1">Ibuprofen</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_3" value="2" id="q3_2">
                            <label class="form-check-label" for="q3_2">Tramadol</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_3" value="3" id="q3_3">
                            <label class="form-check-label" for="q3_3">Codeine</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 4: What diagnostic test is recommended?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_4" value="0" id="q4_0">
                            <label class="form-check-label" for="q4_0">X-ray</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_4" value="1" id="q4_1">
                            <label class="form-check-label" for="q4_1">MRI</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_4" value="2" id="q4_2">
                            <label class="form-check-label" for="q4_2">CT scan</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_4" value="3" id="q4_3">
                            <label class="form-check-label" for="q4_3">Ultrasound</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 5: When should the patient return for follow-up?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_5" value="0" id="q5_0">
                            <label class="form-check-label" for="q5_0">1 week</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_5" value="1" id="q5_1">
                            <label class="form-check-label" for="q5_1">2 weeks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_5" value="2" id="q5_2">
                            <label class="form-check-label" for="q5_2">1 month</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_5" value="3" id="q5_3">
                            <label class="form-check-label" for="q5_3">3 months</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reading Section -->
    <div id="reading-section" class="test-section" style="display: none;">
        <h3><i class="fas fa-book me-2 text-success"></i>Reading Section (60 minutes)</h3>
        
        <div class="alert alert-warning">
            <i class="fas fa-book-open me-2"></i>
            <strong>Instructions:</strong> Read the following texts carefully and answer all questions based on the information provided.
        </div>

        <div class="mb-4">
            <h5>Part A: Patient Information Leaflet</h5>
            <div class="card">
                <div class="card-body">
                    <div class="passage mb-3 p-3 bg-light">
                        <h6><strong>Amoxicillin 500mg Capsules</strong></h6>
                        <p><strong>Dosage:</strong> Take one capsule three times daily with food. Complete the full course even if you feel better.</p>
                        <p><strong>Side Effects:</strong> Common side effects include nausea, diarrhea, and skin rash. If you experience severe allergic reactions such as difficulty breathing or swelling of face and throat, seek immediate medical attention.</p>
                        <p><strong>Warnings:</strong> Do not take if allergic to penicillin. Inform your doctor if you are pregnant or breastfeeding.</p>
                        <p><strong>Storage:</strong> Store in a cool, dry place away from direct sunlight. Keep out of reach of children.</p>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 6: According to the medication leaflet, how often should the antibiotic be taken?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_6" value="0" id="q6_0">
                            <label class="form-check-label" for="q6_0">Once daily</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_6" value="1" id="q6_1">
                            <label class="form-check-label" for="q6_1">Twice daily</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_6" value="2" id="q6_2">
                            <label class="form-check-label" for="q6_2">Three times daily</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_6" value="3" id="q6_3">
                            <label class="form-check-label" for="q6_3">Four times daily</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 7: What is the most serious side effect mentioned?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_7" value="0" id="q7_0">
                            <label class="form-check-label" for="q7_0">Nausea</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_7" value="1" id="q7_1">
                            <label class="form-check-label" for="q7_1">Allergic reaction</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_7" value="2" id="q7_2">
                            <label class="form-check-label" for="q7_2">Drowsiness</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_7" value="3" id="q7_3">
                            <label class="form-check-label" for="q7_3">Headache</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 8: What should patients do if they miss a dose?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_8" value="0" id="q8_0">
                            <label class="form-check-label" for="q8_0">Take double dose next time</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_8" value="1" id="q8_1">
                            <label class="form-check-label" for="q8_1">Skip the missed dose</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_8" value="2" id="q8_2">
                            <label class="form-check-label" for="q8_2">Take as soon as remembered</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_8" value="3" id="q8_3">
                            <label class="form-check-label" for="q8_3">Contact doctor</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 9: According to the discharge summary, what was the primary diagnosis?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_9" value="0" id="q9_0">
                            <label class="form-check-label" for="q9_0">Pneumonia</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_9" value="1" id="q9_1">
                            <label class="form-check-label" for="q9_1">Heart attack</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_9" value="2" id="q9_2">
                            <label class="form-check-label" for="q9_2">Stroke</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_9" value="3" id="q9_3">
                            <label class="form-check-label" for="q9_3">Diabetes</label>
                        </div>
                    </div>

                    <div class="question-container mb-3">
                        <h6>Question 10: What is the recommended follow-up period?</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_10" value="0" id="q10_0">
                            <label class="form-check-label" for="q10_0">1 week</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_10" value="1" id="q10_1">
                            <label class="form-check-label" for="q10_1">2 weeks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_10" value="2" id="q10_2">
                            <label class="form-check-label" for="q10_2">1 month</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_10" value="3" id="q10_3">
                            <label class="form-check-label" for="q10_3">6 weeks</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Writing Section -->
    <div id="writing-section" class="test-section" style="display: none;">
        <h3><i class="fas fa-pen me-2 text-warning"></i>Writing Section (45 minutes)</h3>
        
        <div class="alert alert-warning">
            <i class="fas fa-edit me-2"></i>
            <strong>Instructions:</strong> Write a professional referral letter based on the case study provided. Aim for 180-200 words.
        </div>

        <div class="mb-4">
            <h5>Case Study</h5>
            <div class="card">
                <div class="card-body">
                    <div class="case-details p-3 bg-light mb-3">
                        <h6><strong>Patient Details:</strong></h6>
                        <p><strong>Name:</strong> John Mitchell<br>
                        <strong>Age:</strong> 58<br>
                        <strong>Presenting Complaint:</strong> Progressive shortness of breath and fatigue over 4 weeks</p>
                        
                        <h6><strong>Examination Findings:</strong></h6>
                        <p>Bilateral ankle swelling, elevated JVP, chest X-ray shows cardiomegaly</p>
                        
                        <h6><strong>Current Medication:</strong></h6>
                        <p>Ramipril 5mg daily, Atenolol 50mg daily</p>
                        
                        <h6><strong>Referral Details:</strong></h6>
                        <p><strong>Referring to:</strong> Cardiology<br>
                        <strong>Urgency:</strong> Urgent</p>
                    </div>

                    <div class="writing-task">
                        <h6>Task: Write a referral letter to the Cardiology department</h6>
                        <p><strong>Include:</strong></p>
                        <ul>
                            <li>Patient demographics and presenting complaint</li>
                            <li>Relevant history and examination findings</li>
                            <li>Current medications and treatments tried</li>
                            <li>Reason for referral and level of urgency</li>
                            <li>Specific questions or requests for the specialist</li>
                        </ul>

                        <div class="mb-3">
                            <label for="writing_response" class="form-label"><strong>Your referral letter:</strong></label>
                            <textarea class="form-control" name="question_writing" id="writing_response" rows="12" 
                                      placeholder="Dear Colleague,

I would appreciate your urgent assessment of this 58-year-old gentleman..."></textarea>
                        </div>

                        <div class="word-count">
                            <small class="text-muted">Word count: <span id="wordCount">0</span> / 180-200 words recommended</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Speaking Section -->
    <div id="speaking-section" class="test-section" style="display: none;">
        <h3><i class="fas fa-microphone me-2 text-info"></i>Speaking Section (20 minutes)</h3>
        
        <div class="alert alert-warning">
            <i class="fas fa-comments me-2"></i>
            <strong>Instructions:</strong> Complete two role-play scenarios. You have preparation time before each scenario.
        </div>

        <div class="mb-4">
            <h5>Role Play 1: General Practice Setting</h5>
            <div class="card">
                <div class="card-body">
                    <div class="scenario-details p-3 bg-light mb-3">
                        <p><strong>Setting:</strong> General Practice</p>
                        <p><strong>Your Role:</strong> General Practitioner</p>
                        <p><strong>Patient:</strong> Mrs. Thompson, 42, concerned about irregular periods</p>
                        <p><strong>Task:</strong> Take history and provide appropriate advice</p>
                        <p><strong>Time Limit:</strong> 5 minutes</p>
                    </div>

                    <div class="recording-section">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6>Role Play 1 Recording</h6>
                                <p class="text-muted">Record your response to this scenario</p>
                                
                                <div class="recording-controls mb-3">
                                    <button type="button" id="startRecording1" class="btn btn-success me-2">
                                        <i class="fas fa-microphone"></i> Start Recording
                                    </button>
                                    <button type="button" id="stopRecording1" class="btn btn-danger me-2" disabled>
                                        <i class="fas fa-stop"></i> Stop Recording
                                    </button>
                                    <button type="button" id="playRecording1" class="btn btn-info" disabled>
                                        <i class="fas fa-play"></i> Play Back
                                    </button>
                                </div>
                                
                                <div class="timer">
                                    <span id="recordingTimer1">00:00</span> / 05:00
                                </div>
                                
                                <audio id="audioPlayback1" style="display: none;" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h5>Role Play 2: Hospital Ward Setting</h5>
            <div class="card">
                <div class="card-body">
                    <div class="scenario-details p-3 bg-light mb-3">
                        <p><strong>Setting:</strong> Hospital Ward</p>
                        <p><strong>Your Role:</strong> Staff Nurse</p>
                        <p><strong>Patient:</strong> Mr. Davies, 65, post-operative confusion</p>
                        <p><strong>Task:</strong> Reassure patient and explain procedures</p>
                        <p><strong>Time Limit:</strong> 5 minutes</p>
                    </div>

                    <div class="recording-section">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6>Role Play 2 Recording</h6>
                                <p class="text-muted">Record your response to this scenario</p>
                                
                                <div class="recording-controls mb-3">
                                    <button type="button" id="startRecording2" class="btn btn-success me-2">
                                        <i class="fas fa-microphone"></i> Start Recording
                                    </button>
                                    <button type="button" id="stopRecording2" class="btn btn-danger me-2" disabled>
                                        <i class="fas fa-stop"></i> Stop Recording
                                    </button>
                                    <button type="button" id="playRecording2" class="btn btn-info" disabled>
                                        <i class="fas fa-play"></i> Play Back
                                    </button>
                                </div>
                                
                                <div class="timer">
                                    <span id="recordingTimer2">00:00</span> / 05:00
                                </div>
                                
                                <audio id="audioPlayback2" style="display: none;" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden inputs for speaking responses -->
        <input type="hidden" name="question_speaking1" id="speakingData1" value="">
        <input type="hidden" name="question_speaking2" id="speakingData2" value="">
    </div>
</div>

<script>
// Section navigation
function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.test-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.section-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionName + '-section').style.display = 'block';
    
    // Add active class to clicked button
    event.target.closest('.section-btn').classList.add('active');
}

// Word count for writing section
document.getElementById('writing_response').addEventListener('input', function() {
    const text = this.value.trim();
    const wordCount = text === '' ? 0 : text.split(/\s+/).length;
    document.getElementById('wordCount').textContent = wordCount;
});

// Recording functionality for speaking section
let mediaRecorder1, mediaRecorder2;
let audioChunks1 = [], audioChunks2 = [];
let recordingTimer1, recordingTimer2;
let startTime1, startTime2;

// Role Play 1 Recording
document.getElementById('startRecording1').addEventListener('click', async function() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder1 = new MediaRecorder(stream);
        audioChunks1 = [];
        
        mediaRecorder1.ondataavailable = event => {
            audioChunks1.push(event.data);
        };
        
        mediaRecorder1.onstop = () => {
            const audioBlob = new Blob(audioChunks1, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            document.getElementById('audioPlayback1').src = audioUrl;
            document.getElementById('audioPlayback1').style.display = 'block';
            document.getElementById('playRecording1').disabled = false;
            
            // Convert to base64 for storage
            const reader = new FileReader();
            reader.onloadend = function() {
                document.getElementById('speakingData1').value = reader.result;
            };
            reader.readAsDataURL(audioBlob);
        };
        
        mediaRecorder1.start();
        startTime1 = Date.now();
        
        // Update UI
        document.getElementById('startRecording1').disabled = true;
        document.getElementById('stopRecording1').disabled = false;
        
        // Start timer
        recordingTimer1 = setInterval(() => updateTimer('recordingTimer1', startTime1), 1000);
        
        // Auto-stop after 5 minutes
        setTimeout(() => {
            if (mediaRecorder1.state === 'recording') {
                document.getElementById('stopRecording1').click();
            }
        }, 300000);
        
    } catch (err) {
        alert('Could not access microphone: ' + err.message);
    }
});

document.getElementById('stopRecording1').addEventListener('click', function() {
    if (mediaRecorder1 && mediaRecorder1.state === 'recording') {
        mediaRecorder1.stop();
        mediaRecorder1.stream.getTracks().forEach(track => track.stop());
        
        clearInterval(recordingTimer1);
        
        document.getElementById('startRecording1').disabled = false;
        document.getElementById('stopRecording1').disabled = true;
    }
});

// Role Play 2 Recording (similar implementation)
document.getElementById('startRecording2').addEventListener('click', async function() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder2 = new MediaRecorder(stream);
        audioChunks2 = [];
        
        mediaRecorder2.ondataavailable = event => {
            audioChunks2.push(event.data);
        };
        
        mediaRecorder2.onstop = () => {
            const audioBlob = new Blob(audioChunks2, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            document.getElementById('audioPlayback2').src = audioUrl;
            document.getElementById('audioPlayback2').style.display = 'block';
            document.getElementById('playRecording2').disabled = false;
            
            const reader = new FileReader();
            reader.onloadend = function() {
                document.getElementById('speakingData2').value = reader.result;
            };
            reader.readAsDataURL(audioBlob);
        };
        
        mediaRecorder2.start();
        startTime2 = Date.now();
        
        document.getElementById('startRecording2').disabled = true;
        document.getElementById('stopRecording2').disabled = false;
        
        recordingTimer2 = setInterval(() => updateTimer('recordingTimer2', startTime2), 1000);
        
        setTimeout(() => {
            if (mediaRecorder2.state === 'recording') {
                document.getElementById('stopRecording2').click();
            }
        }, 300000);
        
    } catch (err) {
        alert('Could not access microphone: ' + err.message);
    }
});

document.getElementById('stopRecording2').addEventListener('click', function() {
    if (mediaRecorder2 && mediaRecorder2.state === 'recording') {
        mediaRecorder2.stop();
        mediaRecorder2.stream.getTracks().forEach(track => track.stop());
        
        clearInterval(recordingTimer2);
        
        document.getElementById('startRecording2').disabled = false;
        document.getElementById('stopRecording2').disabled = true;
    }
});

function updateTimer(elementId, startTime) {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById(elementId).textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Playback controls
document.getElementById('playRecording1').addEventListener('click', function() {
    const audio = document.getElementById('audioPlayback1');
    if (audio.paused) {
        audio.play();
    } else {
        audio.pause();
    }
});

document.getElementById('playRecording2').addEventListener('click', function() {
    const audio = document.getElementById('audioPlayback2');
    if (audio.paused) {
        audio.play();
    } else {
        audio.pause();
    }
});

// Correct answers for scoring
const correctAnswers = {
    'question_1': '0',   // Back pain
    'question_2': '2',   // 3 weeks
    'question_3': '2',   // Tramadol
    'question_4': '1',   // MRI
    'question_5': '1',   // 2 weeks
    'question_6': '2',   // Three times daily
    'question_7': '1',   // Allergic reaction
    'question_8': '2',   // Take as soon as remembered
    'question_9': '1',   // Heart attack
    'question_10': '2',  // 1 month
    'question_writing': 'manual_grading_required',
    'question_speaking1': 'manual_grading_required',
    'question_speaking2': 'manual_grading_required'
};

// Store correct answers in a global variable for access in routes
window.testAnswers = correctAnswers;
</script>
